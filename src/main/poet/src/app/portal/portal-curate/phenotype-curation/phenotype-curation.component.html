<mat-card class="phenotype-card form-card">
  <mat-card-title>
    <mat-icon class="form-icon-left lock" *ngIf="formControlGroup.disabled"
              matTooltip="View Mode Only"
              matTooltipPosition="below">
      lock
    </mat-icon>
    <mat-icon class="form-icon-left unlock" *ngIf="!formControlGroup.disabled"
              matTooltip="Editing Mode"
              matTooltipPosition="below">
      lock_open
    </mat-icon>
    <mat-icon class="form-icon-left messages" *ngIf="utilityService.hasReviewerComments(selectedAnnotation)
    && utilityService.isNeedsWork(this.selectedAnnotation)"
              (click)="utilityService.openMessagesDialog(this.selectedAnnotation.reviewMessages)">
      mark_chat_unread
    </mat-icon>
    {{title}}
    <mat-icon class="help-icon" (click)="closeForm()" matTooltip="Close Form"
              matTooltipShowDelay="500">cancel</mat-icon>
  </mat-card-title>
  <mat-card-subtitle>
    Human Phenotype Ontology [ HPO ]
    <p class="extra-information" *ngIf="selectedAnnotation?.owner.nickname">
      {{selectedAnnotation.owner.nickname}} updated on {{selectedAnnotation.lastUpdatedDate}} </p>
  </mat-card-subtitle>
  <mat-card-content>
    <button mat-raised-button color="primary" (click)="selectPublication()"
            *ngIf="selectedPublications.length === 0">Select Source
    </button>
    <span class="source-required" *ngIf="selectedPublications.length === 0">
       * A source is required to submit this annotation.
    </span>
    <mat-list class="publication-list" aria-label="publication selection">
      <mat-list-item *ngFor="let publication of selectedPublications">
        <span *ngIf="!utilityService.isDiseaseSource(publication.publicationId)">
            {{publication.publicationName}} {{publication.publicationId}}
        </span>
        <span *ngIf="utilityService.isDiseaseSource(publication.publicationId)">
            {{publication.publicationName}}{{publication.publicationId}}
        </span>
        <span class="spacer"></span>
        <mat-icon class="remove-icon" (click)="removePublication(publication)" *ngIf="!formControlGroup.disabled">cancel</mat-icon>
      </mat-list-item>
    </mat-list>
     <form [formGroup]="formControlGroup" fxLayout="column" fxLayoutAlign="start stretch">
      <div class="form-content-section" fxFlex="100">
        <mat-form-field class="phenotype-form" appearance="fill">
          <mat-label>HPO Term</mat-label>
          <mat-hint *ngIf="!formControlGroup.get('hpoFormControl').hasError('notFound') &&
          !formControlGroup.get('hpoFormControl').hasError('apiError') && !formControlGroup.disabled">
            e.g. arachnodactyly</mat-hint>
          <mat-hint *ngIf="formControlGroup.get('hpoFormControl').hasError('notFound') && !formControlGroup.disabled">
            <span class="mat-error">Sorry we could not find what you were looking for!</span>
          </mat-hint>
          <mat-hint *ngIf="formControlGroup.get('hpoFormControl').hasError('apiError') && !formControlGroup.disabled">
            <span class="mat-error">The connection for this data is broken, please contact us!</span>
          </mat-hint>
          <input matInput formControlName="hpoFormControl" ngDefaultControl
                 [matAutocomplete]="hpo" required>
          <button mat-button *ngIf="formControlGroup.get('hpoFormControl').value !== null && !formControlGroup.disabled" matSuffix mat-icon-button
                  aria-label="Clear" (click)="formControlGroup.get('hpoFormControl').reset()">
            <mat-icon>close</mat-icon>
          </button>
          <mat-autocomplete #hpo="matAutocomplete" (optionSelected)="selectedHpo = $event.option.value"
                            [displayWith]="utilityService.displayHpoFn">
            <mat-option *ngIf="loadingHpoSuggestions">
              <mat-progress-bar mode="query"></mat-progress-bar>
            </mat-option>
            <mat-option class="auto-complete-option" *ngFor="let option of hpoOptions" [value]="option">
              <span class="option-name">{{option.name}}</span>
              &nbsp;
              <span class="option-id">{{option.id}}</span>
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
        <div [ngClass]="{'qualifier': formControlGroup.get('hpoFormControl').value === null, 'fr': true}">
          <mat-checkbox aria-label="Is Qualified?" formControlName="qualifierFormControl"
                        [(ngModel)]="selectedQualifier">
            NOT CHARACTERIZED <span class="form-field-help-icon material-icons"
                                    matTooltip="Select if this phenotype is not observed in the disease."
                                    matTooltipPosition="below">
              help_outline
            </span>
          </mat-checkbox>
        </div>
      </div>
      <div class="form-content-section" fxFlex="100">
        <mat-form-field class="phenotype-form" appearance="fill">
          <mat-label>HPO Clinical Modifiers</mat-label>
          <mat-hint *ngIf="!formControlGroup.get('modifierFormControl').hasError('notFound') &&
          !formControlGroup.get('modifierFormControl').hasError('apiError')  && !formControlGroup.disabled">
          The speed of progression, triggering factors, location or severity.</mat-hint>
          <mat-hint *ngIf="formControlGroup.get('modifierFormControl').hasError('notFound') && !formControlGroup.disabled">
            <span class="mat-error">Sorry we could not find what you were looking for!</span>
          </mat-hint>
          <mat-hint *ngIf="formControlGroup.get('modifierFormControl').hasError('apiError') && !formControlGroup.disabled">
            <span class="mat-error">The connection for this data is broken, please contact us!</span>
          </mat-hint>
          <mat-chip-list #chipList aria-label="Modifier Selection" [disabled]="formControlGroup.get('modifierFormControl').disabled">
            <mat-chip
              *ngFor="let modifier of selectedModifiers"
              [removable]="true"
              (removed)="removeModifiers(modifier)">
              {{modifier}}
              <mat-icon matChipRemove>cancel</mat-icon>
            </mat-chip>
            <input
              placeholder="Add HPO Modifier"
              #modifierInput
              formControlName="modifierFormControl"
              [matAutocomplete]="modifier"
              [matChipInputFor]="chipList"
              [matChipInputSeparatorKeyCodes]="separatorKeysCodes">
          </mat-chip-list>
          <mat-autocomplete #modifier="matAutocomplete" (optionSelected)="selectedModifier($event)">
            <mat-option *ngIf="loadingModifierSuggestions">
              <mat-progress-bar mode="query"></mat-progress-bar>
            </mat-option>
            <mat-option *ngFor="let modifier of modifierOptions" [value]="modifier.ontologyId">
              <span class="option-name">{{modifier.name}}</span>&nbsp;
              <span class="option-id">{{modifier.ontologyId}}</span>
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
      </div>
      <div class="form-content-section">
        <mat-form-field appearance="fill">
          <mat-label>HPO Age Of Onset</mat-label>
          <mat-select formControlName="onsetFormControl">
            <mat-option>Unset</mat-option>
            <mat-option *ngFor="let option of onsetOptions" [value]="option">
              <span class="option-name">{{option.name}}</span>
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="fill" class="ml1">
          <mat-label>HPO Frequency</mat-label>
          <input matInput placeholder="..." formControlName="frequencyFormControl" ngDefaultControl
                 [matAutocomplete]="frequency">
          <button mat-button *ngIf="formControlGroup.get('frequencyFormControl').value !== null && !formControlGroup.disabled" matSuffix mat-icon-button
                  aria-label="Clear" (click)="formControlGroup.get('frequencyFormControl').reset(); frequencyOptions = []; selectedFrequency = null ">
            <mat-icon>close</mat-icon>
          </button>
          <mat-hint *ngIf="!formControlGroup.disabled">e.g. 10/20, 50% or Frequent</mat-hint>
          <mat-error *ngIf="formControlGroup.get('frequencyFormControl').hasError('notFound')">
            Looks like there was an error with the HPO API.
          </mat-error>
          <mat-autocomplete #frequency="matAutocomplete" (optionSelected)="selectedFrequency = $event.option.value"
                            [displayWith]="utilityService.displayFrequency">
            <mat-option class="auto-complete-option" *ngFor="let option of frequencyOptions" [value]="option">
              <span class="option-name">{{option.name}}</span>&nbsp;
              <span class="option-id">{{option.ontologyId}}</span>
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
        <mat-form-field appearance="fill" class="ml1" >
          <mat-label>Sex</mat-label>
          <mat-select formControlName="sexFormControl">
            <mat-option>
              UNSET
            </mat-option>
            <mat-option value="MALE">
              MALE
            </mat-option>
            <mat-option value="FEMALE">
              FEMALE
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="form-content-section">
        <mat-form-field appearance="fill" class="evidence">
          <mat-label>Evidence</mat-label>
          <mat-select formControlName="evidenceFormControl">
            <mat-option value="TAS">Traceable Author Statement</mat-option>
            <mat-option value="PCS">Published Clinical Study</mat-option>
            <mat-option value="IEA" [disabled]="true">Inferred Electronic Annotation</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="form-content-section">
        <mat-form-field class="phenotype-form" appearance="fill">
          <mat-label>Additional Description</mat-label>
          <input matInput type="text" formControlName="descriptionFormControl" maxlength="50">
          <mat-hint *ngIf="this.formControlGroup.get('descriptionFormControl').value?.length >= 50">Maximum Characters Reached.</mat-hint>
          <button mat-button *ngIf="formControlGroup.get('descriptionFormControl').value !== '' && !formControlGroup.disabled" matSuffix mat-icon-button
                  aria-label="Clear"
                  (click)="formControlGroup.get('descriptionFormControl').reset()">
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>
      </div>
    </form>
  </mat-card-content>
  <mat-card-actions>
    <div class="left-actions">
      <button class="approve-annotation" mat-raised-button aria-label="Approve Phenotype Annotation"
              *ngIf="(utilityService.showElevatedActions(userRole, selectedAnnotation) && !elevatedChanges) ||
              (elevatedChanges && !this.formControlGroup.pristine && this.formControlGroup.valid)" (click)="reviewAnnotation('approve')">
        {{elevatedButtonText.approve.display}}
      </button>
      <button class="deny-annotation" mat-raised-button aria-label="Deny Phenotype Annotation"
              *ngIf="utilityService.showElevatedActions(userRole, selectedAnnotation) && !elevatedChanges" (click)="reviewAnnotation('deny')">
        {{elevatedButtonText.deny.display}}
      </button>
      <button class="deny-annotation" mat-raised-button aria-label="Cancel Current Review"
              *ngIf="utilityService.showElevatedActions(userRole, selectedAnnotation) && elevatedChanges" (click)="toggleAnnotationChanges(false)">
        Cancel
      </button>
      <button class="edit-annotation" mat-raised-button aria-label="Edit Phenotype Annotation"
              *ngIf="utilityService.showElevatedActions(userRole, selectedAnnotation) && elevatedButtonText.changes.show"
              (click)="toggleAnnotationChanges(true)">
        {{elevatedButtonText.changes.display}}
      </button>
      <button mat-raised-button color="primary" *ngIf="everythingValid() && !utilityService.showElevatedActions(userRole, selectedAnnotation)" (click)="submitForm()">SUBMIT</button>
      <mat-spinner color="accent" [diameter]="20" mode="indeterminate" *ngIf="savingAnnotation"></mat-spinner>
    </div>
    <div class="right-actions">
      <button mat-stroked-button (click)="resetPhenotypeForm()" *ngIf="!formControlGroup.disabled && !elevatedChanges">Clear</button>
      <a mat-flat-button aria-label="Report Phenotype Annotation"
         matTooltip="Report Phenotype Annotation Bug"
         matTooltipShowDelay="775"
         *ngIf="this.utilityService.isOfficial(selectedAnnotation)"
         href="https://github.com/obophenotype/human-phenotype-ontology/issues/new?assignees=drseb&labels=HPOA&template=h_new_annotation.md&title=" target="_blank">
        Report Annotation Issue
      </a>
    </div>
  </mat-card-actions>
</mat-card>
